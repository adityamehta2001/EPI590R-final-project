---
title: "EPI 590R: Final Project Analysis"
author: "Aditya Mehta"
format: html
editor: visual
css: styles.css
execute:
  echo: false
---

```{r}
#| label: Loading Data
#| output: false
library(here)
library(tidyverse)
library(dplyr)
library(gtsummary)
library(janitor)

#Loading COVID-19 death count data by week ending date and state, downloaded from CDC
data <- read_csv(here::here("data/raw/COVID_Data.csv"))

#Cleaning variable names to reflect R formatting with underscores
data <- janitor::clean_names(data)
```

```{r}
#| label: tbl-one
#| tbl-cap: Descriptive Statistics of Included Data

Table_1 <- tbl_summary(
  data, 
  by = race_or_hispanic_origin, 
  include= c(ends_with("Deaths"), sex, education_level, age_group), 
  label = list (
    education_level ~ "Education Level",
    age_group ~ "Age Group",
    covid_19_deaths ~ "COVID-19 Deaths",
    total_deaths ~ "Total Deaths",
    sex ~ "Sex"
  ),
  missing_text = "Missing") |>
  bold_labels() |>
  modify_header(label="**Variable**")
Table_1
COVID_Deaths_Hispanic <- inline_text(Table_1, variable = covid_19_deaths , column = "stat_1")
Total_Deaths_Hispanic <- inline_text(Table_1, variable = total_deaths , column = "stat_1")
```

As seen in @tbl-one, there were `r nrow(data)` total observations across all the race/Hispanic origin categories, but these were due to how data was standardized across all the categorical variables to ensure that aggregate COVID-19 and total death counts were equal across the different strata. Therefore, this total observation value does not refer to the total number of people included in the mortality data (as evidenced by the larger counts of deaths in each category). Among data collected from Hispanic people, there were `r COVID_Deaths_Hispanic` median deaths (Q1, Q3) from COVID-19 and `r Total_Deaths_Hispanic` median deaths (Q1, Q3) overall. 

```{r}
#| label: tbl-two
#| tbl-cap: Linear regression model, x = race/Hispanic origin, sex, education level, age group, y = COVID-19 deaths
#Defining variables as factors for use in linear regression model
data$race_or_hispanic_origin <- as.factor(data$race_or_hispanic_origin)
data$sex <- as.factor(data$sex)
data$education_level <- as.factor(data$education_level)
data$age_group <- as.factor(data$age_group)

#Linear regression table since using COVID mortality counts
linear_model <- lm(covid_19_deaths ~ race_or_hispanic_origin +
                   sex + education_level + age_group, 
                   data = data)

#Created new function for model 
new_table_function <- function(model){
  tbl_regression(
    linear_model,
    intercept = FALSE,
    label = list(
      race_or_hispanic_origin ~ "Race or Hispanic Origin",
      sex ~ "Sex",
      education_level ~ "Education Level",
      age_group ~ "Age Group"
    )
  ) |>
    bold_labels() |>
    modify_header(label="**Variable**")
}

new_table_function(linear_model)
```

@tbl-two is different from @tbl-one, as it shows results of a multiple linear regression and not solely descriptive statistics about the selected data (which you can find in @tbl-one). @fig-hist, shown below, also demonstrates a histogram plot of the residuals calculated from @tbl-two.

The mean number of COVID-19 deaths among **all races** from this data is `r mean(data$covid_19_deaths, na.rm = TRUE)` deaths.


```{r}
#| label: fig-hist
#| fig-cap: This represents a histogram of residuals from the linear regression model.

residuals <- residuals(linear_model)
hist(residuals, main = "Histogram of Residuals", xlab = "Residuals", col = "turquoise",
     border = "black")

```
